<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>STAC: Code Grey - Photon Studios</title>
  <style>
    /* (CSS kept exactly as before) */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: Arial, sans-serif;
      color: white;
      background: #1b2838;
      overflow-x: hidden;
      position: relative;
    }
    #bg-video { position: fixed; top:0; left:0; width:100vw; height:100vh; object-fit:cover; z-index:-2; }
    .dark-overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); z-index:-1; }
    .navbar { position: fixed; top:0; width:100%; display:flex; justify-content:space-between; align-items:center; padding:15px 40px; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); z-index:100; }
    .logo { font-size:1.8rem; font-weight:bold; color:#fff; }
    .nav-links { display:flex; gap:30px; }
    .nav-links a { color:#ccc; text-decoration:none; transition:0.3s; }
    .nav-links a:hover { color:#fff; }
    #login-btn { padding:8px 15px; background:rgba(255,255,255,0.12); border:1px solid white; border-radius:6px; color:white; cursor:pointer; backdrop-filter: blur(6px); font-weight:bold; }
    #login-btn:hover { background: rgba(255,255,255,0.25); }
    .container { padding: 100px 40px 40px; }
    .game-header { text-align:center; margin-bottom:30px; }
    .game-title { font-size:2.5rem; margin-bottom:10px; }
    .game-tagline { font-size:1.2rem; color:#aaa; margin-bottom:20px; }
    .game-image-main { width:100%; max-width:800px; margin:0 auto 20px; display:block; border-radius:8px; object-fit:cover; height:400px; }
    .game-meta { display:flex; justify-content:center; gap:20px; margin-bottom:20px; flex-wrap:wrap; }
    .meta-item { background: rgba(50,60,70,0.6); padding:8px 15px; border-radius:4px; }
    .game-description { max-width:800px; margin:0 auto 30px; line-height:1.6; }
    .game-actions { text-align:center; margin-bottom:30px; }
    .btn-buy, .btn-wish { padding:12px 25px; border:none; border-radius:4px; cursor:pointer; margin:0 10px; font-size:1rem; transition:0.2s; }
    .btn-buy { background:#5aa9e6; color:white; } .btn-buy:hover { background:#4a99d6; }
    .btn-wish { background: rgba(255,255,255,0.1); color:white; border:1px solid #555; } .btn-wish:hover { background: rgba(255,255,255,0.2); }
    .btn-wish.active { background:#4caf50; }
    .like-dislike-section { text-align:center; margin:20px 0 40px; }
    .like-dislike-buttons { display:inline-flex; gap:15px; align-items:center; }
    .like-btn, .dislike-btn { background:none; border:none; color:#999; cursor:pointer; font-size:1.8rem; transition:0.2s; padding:5px; }
    .like-btn:hover, .dislike-btn:hover { color:#5aa9e6; }
    .like-btn.active { color:#4caf50; } .dislike-btn.active { color:#f44336; }
    .rating-count { font-size:1rem; color:#aaa; margin:0 10px; }
    .comments-section { max-width:800px; margin:0 auto; }
    .comments-header { margin-bottom:20px; } .comments-header h2 { display:inline-block; margin-right:15px; }
    .comments-sort { display:inline-block; }
    .comment-form { margin-bottom:30px; }
    .comment-form textarea { width:100%; padding:10px; border-radius:4px; border:1px solid #555; background: rgba(30,40,50,0.8); color:white; resize:vertical; min-height:80px; margin-bottom:10px; }
    .comment-form button { padding:10px 20px; background:#5aa9e6; color:white; border:none; border-radius:4px; cursor:pointer; } .comment-form button:hover { background:#4a99d6; }
    .comment-list { } .comment-item { padding:15px; background: rgba(30,40,50,0.6); border-radius:4px; margin-bottom:15px; }
    .comment-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .comment-author { font-weight:bold; color:#5aa9e6; } .comment-date { font-size:0.8rem; color:#777; } .comment-content { line-height:1.5; } .comment-actions { margin-top:8px; }
    .comment-like-btn, .comment-dislike-btn { background:none; border:none; color:#999; cursor:pointer; font-size:0.9rem; margin-right:10px; } .comment-like-btn:hover, .comment-dislike-btn:hover { color:#5aa9e6; } .comment-like-btn.active { color:#4caf50; } .comment-dislike-btn.active { color:#f44336; } .comment-rating-count { font-size:0.8rem; color:#aaa; margin-left:5px; }
    .price { display:inline-block; margin-left:8px; font-weight:bold; color:#fff; background: rgba(0,0,0,0.3); padding:6px 10px; border-radius:6px; }
  </style>
</head>
<body>
  <video id="bg-video" autoplay muted loop>
    <source src="../videos/blackhole.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>
  <div class="dark-overlay"></div>

  <div class="navbar">
    <div class="logo">PHOTON STUDIOS</div>
    <div style="display:flex;align-items:center;gap:30px;">
      <div class="nav-links">
        <a href="../index.html">Home</a>
        <a href="../photonstore.html">Shop</a>
        <a href="../photonstudio.html">News</a>
      </div>
      <button id="login-btn">Login</button>
    </div>
  </div>

  <div class="container">
    <div class="game-header">
      <h1 class="game-title">STAC: Code Grey</h1>
      <p class="game-tagline">Deeper than dark, covert missions unfold</p>
      <img src="https://placehold.co/800x400/222222/FFFFFF?text=STAC+Code+Grey" alt="STAC: Code Grey Banner" class="game-image-main">
      <div class="game-meta">
        <div class="meta-item">Developer: Photon Studios</div>
        <div class="meta-item">Publisher: Photon Studios</div>
        <div class="meta-item">Release Date: 21st December 2025</div>
        <div class="meta-item">Genre: Action / Tactical</div>
      </div>
    </div>

    <div class="game-description">
      <p>STAC: Code Grey plunges you into the shadows of covert operations. Join the elite STAC agents as they dismantle a web of corruption and drug syndicates funded by MCA-6. Tactical combat, stealth operations, and cinematic sequences await.</p>
      <p>Features:</p>
      <ul>
        <li>Seven elite agents with unique skills</li>
        <li>Multi-mission tactical gameplay</li>
        <li>Intense cinematic cutscenes</li>
        <li>Stealth and combat mechanics</li>
        <li>Pay-As-You-Like system</li>
      </ul>
    </div>

    <div class="game-actions">
      <a href="https://gamejolt.com/games/stac-code-grey/123456" target="_blank" class="btn-buy" id="buy-btn">Download on Game Jolt</a>
      <button class="btn-wish" id="wish-btn">Add to Wishlist</button>
    </div>

    <div class="like-dislike-section">
      <h3>How do you feel about STAC: Code Grey?</h3>
      <div class="like-dislike-buttons">
        <button class="like-btn" id="like-btn">ğŸ‘</button>
        <span class="rating-count" id="like-count">0</span>
        <span> / </span>
        <span class="rating-count" id="dislike-count">0</span>
        <button class="dislike-btn" id="dislike-btn">ğŸ‘</button>
      </div>
    </div>

    <div class="comments-section">
      <div class="comments-header">
        <h2>Community Reviews</h2>
        <select class="comments-sort" id="comments-sort">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="popular">Most Popular</option>
        </select>
      </div>

      <div class="comment-form">
        <textarea id="comment-input" placeholder="Write your review or comment..."></textarea>
        <button id="post-comment-btn">Post Comment</button>
      </div>

      <div class="comment-list" id="comment-list"></div>
    </div>
  </div>

  <script type="module">
Â  Â  // ---------------------------
Â  Â  // Firebase SDK imports
Â  Â  // ---------------------------
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
Â  Â  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
Â  Â  import {
Â  Â  Â  getFirestore, doc, getDoc, setDoc, updateDoc, increment,
Â  Â  Â  query, collection, orderBy, getDocs, addDoc, deleteField,
Â  Â  Â  arrayUnion, arrayRemove, serverTimestamp, deleteDoc
Â  Â  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

Â  Â  // ---------------------------
Â  Â  // Config - keep your config
Â  Â  // ---------------------------
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyCsulwdk4ryzoCwpuKji5a8b-jXeG5ews4",
Â  Â  Â  authDomain: "photon-userbase.firebaseapp.com",
Â  Â  Â  projectId: "photon-userbase",
Â  Â  Â  storageBucket: "photon-userbase.firebasestorage.app",
Â  Â  Â  messagingSenderId: "66493624110",
Â  Â  Â  appId: "1:66493624110:web:d820995afc5b2bcad354bf",
Â  Â  Â  measurementId: "G-9RJRPKKNZV"
Â  Â  };

Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const auth = getAuth(app);
Â  Â  const db = getFirestore(app);
Â  Â  const provider = new GoogleAuthProvider();

Â  Â  // ---------------------------
Â  Â  // App state + constants
Â  Â  // ---------------------------
Â  Â  let currentUser = null;
Â  Â  const gameId = 'portal-tld';
Â  Â  // MODIFICATION: Set base price to 0.00 to indicate it's free.
Â  Â  const BASE_USD_PRICE = 0.00; 

Â  Â  // DOM refs (grab now; some may be updated after DOMContentLoaded)
Â  Â  const loginBtn = document.getElementById('login-btn');
Â  Â  const likeBtn = document.getElementById('like-btn');
Â  Â  const dislikeBtn = document.getElementById('dislike-btn');
Â  Â  const likeCountEl = document.getElementById('like-count');
Â  Â  const dislikeCountEl = document.getElementById('dislike-count');
Â  Â  const commentInput = document.getElementById('comment-input');
Â  Â  const postCommentBtn = document.getElementById('post-comment-btn');
Â  Â  const commentListEl = document.getElementById('comment-list');
Â  Â  const commentsSortEl = document.getElementById('comments-sort');
Â  Â  const buyBtn = document.getElementById('buy-btn');
Â  Â  const wishBtn = document.getElementById('wish-btn');
Â  Â  const priceEl = document.getElementById('price-el');

Â  Â  // ---------------------------
Â  Â  // Utility: ensure a document exists and has default fields if missing
Â  Â  // ---------------------------
Â  Â  async function ensureDoc(docRef, defaultData = {}) {
Â  Â  Â  try {
Â  Â  Â  Â  const snap = await getDoc(docRef);
Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  await setDoc(docRef, defaultData, { merge: true });
Â  Â  Â  Â  Â  console.log('Created missing doc:', docRef.path);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // ensure missing fields within existing doc are patched
Â  Â  Â  Â  Â  const data = snap.data();
Â  Â  Â  Â  Â  const update = {};
Â  Â  Â  Â  Â  for (const k in defaultData) {
Â  Â  Â  Â  Â  Â  if (!(k in data)) update[k] = defaultData[k];
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (Object.keys(update).length) {
Â  Â  Â  Â  Â  Â  await updateDoc(docRef, update);
Â  Â  Â  Â  Â  Â  console.log('Patched missing fields for:', docRef.path, update);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('ensureDoc error', err);
Â  Â  Â  Â  throw err;
Â  Â  Â  }
Â  Â  }

Â  Â  // helper to get a docRef by path parts
Â  Â  function docRefFromParts(...parts) {
Â  Â  Â  // Usage: docRefFromParts('games','portal-tld')
Â  Â  Â  if (parts.length % 2 === 0) {
Â  Â  Â  Â  // even parts => last is doc id, so treat as doc path
Â  Â  Â  Â  return doc(db, ...parts);
Â  Â  Â  } else {
Â  Â  Â  Â  // odd number - last was intended as collection? fallback to doc(...)
Â  Â  Â  Â  return doc(db, ...parts);
Â  Â  Â  }
Â  Â  }

Â  Â  // ---------------------------
Â  Â  // Auth handling
Â  Â  // ---------------------------
Â  Â  onAuthStateChanged(auth, async (user) => {
Â  Â  Â  currentUser = user;
Â  Â  Â  if (user) {
Â  Â  Â  Â  console.log('User is signed in:', user.uid);
Â  Â  Â  Â  loginBtn.textContent = user.displayName || user.email || 'Logged In';

Â  Â  Â  Â  // ensure user profile exists and has wishlist array
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const userRef = doc(db, 'users', user.uid);
Â  Â  Â  Â  Â  await ensureDoc(userRef, { wishlist: [] });
Â  Â  Â  Â  Â  checkWishlistStatus();
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  console.error('Failed creating/ensuring user profile', err);
Â  Â  Â  Â  Â  wishBtn.disabled = true;
Â  Â  Â  Â  Â  wishBtn.textContent = 'Error loading wishlist';
Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  console.log('No user signed in');
Â  Â  Â  Â  loginBtn.textContent = 'Login';
Â  Â  Â  Â  wishBtn.textContent = 'Add to Wishlist';
Â  Â  Â  Â  wishBtn.classList.remove('active');
Â  Â  Â  Â  wishBtn.disabled = false;
Â  Â  Â  }
Â  Â  });

Â  Â  loginBtn.addEventListener('click', () => {
Â  Â  Â  if (currentUser) {
Â  Â  Â  Â  signOut(auth).catch(err => console.error('SignOut error', err));
Â  Â  Â  } else {
Â  Â  Â  Â  signInWithPopup(auth, provider)
Â  Â  Â  Â  Â  .then(result => { currentUser = result.user; console.log('Signed in', currentUser.uid); })
Â  Â  Â  Â  Â  .catch(err => { console.error('SignIn error', err); alert('Login failed: ' + err.message); });
Â  Â  Â  }
Â  Â  });

Â  Â  // ---------------------------
Â  Â  // Wishlist: check & toggle (safe)
Â  Â  // ---------------------------
Â  Â  async function checkWishlistStatus() {
Â  Â  Â  if (!currentUser) return;
Â  Â  Â  const userRef = doc(db, 'users', currentUser.uid);
Â  Â  Â  try {
Â  Â  Â  Â  const snap = await getDoc(userRef);
Â  Â  Â  Â  const data = snap.exists() ? snap.data() : {};
Â  Â  Â  Â  const wishlist = data.wishlist || [];
Â  Â  Â  Â  if (wishlist.includes(gameId)) {
Â  Â  Â  Â  Â  wishBtn.textContent = 'Remove from Wishlist';
Â  Â  Â  Â  Â  wishBtn.classList.add('active');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  wishBtn.textContent = 'Add to Wishlist';
Â  Â  Â  Â  Â  wishBtn.classList.remove('active');
Â  Â  Â  Â  }
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('checkWishlistStatus error', err);
Â  Â  Â  Â  wishBtn.disabled = true;
Â  Â  Â  Â  wishBtn.textContent = 'Error checking wishlist';
Â  Â  Â  }
Â  Â  }

Â  Â  async function handleWishlistToggle() {
Â  Â  Â  if (!currentUser) { alert('Please log in to manage your wishlist.'); return; }
Â  Â  Â  const userRef = doc(db, 'users', currentUser.uid);
Â  Â  Â  try {
Â  Â  Â  Â  // ensure user doc exists
Â  Â  Â  Â  await ensureDoc(userRef, { wishlist: [] });
Â  Â  Â  Â  const snap = await getDoc(userRef);
Â  Â  Â  Â  const wishlist = snap.data().wishlist || [];
Â  Â  Â  Â  if (wishlist.includes(gameId)) {
Â  Â  Â  Â  Â  await updateDoc(userRef, { wishlist: arrayRemove(gameId) });
Â  Â  Â  Â  Â  wishBtn.textContent = 'Add to Wishlist';
Â  Â  Â  Â  Â  wishBtn.classList.remove('active');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  await updateDoc(userRef, { wishlist: arrayUnion(gameId) });
Â  Â  Â  Â  Â  wishBtn.textContent = 'Remove from Wishlist';
Â  Â  Â  Â  Â  wishBtn.classList.add('active');
Â  Â  Â  Â  }
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('Error updating wishlist:', err);
Â  Â  Â  Â  alert('An error occurred updating your wishlist. Please try again.');
Â  Â  Â  Â  checkWishlistStatus();
Â  Â  Â  }
Â  Â  }

Â  Â  // ---------------------------
Â  Â  // Load / ensure game doc (likes/dislikes)
Â  Â  // ---------------------------
Â  Â  async function loadGameRatings() {
Â  Â  Â  const gameRef = doc(db, 'games', gameId);
Â  Â  Â  try {
Â  Â  Â  Â  // Ensure game doc exists and has likes/dislikes fields
Â  Â  Â  Â  await ensureDoc(gameRef, { likes: 0, dislikes: 0, title: 'Portal TLD', createdBy: 'photon' });
Â  Â  Â  Â  const snap = await getDoc(gameRef);
Â  Â  Â  Â  const data = snap.data();
Â  Â  Â  Â  likeCountEl.textContent = data.likes || 0;
Â  Â  Â  Â  dislikeCountEl.textContent = data.dislikes || 0;
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('Error loading game ratings:', err);
Â  Â  Â  Â  likeCountEl.textContent = 'Err';
Â  Â  Â  Â  dislikeCountEl.textContent = 'Err';
Â  Â  Â  }
Â  Â  }

Â  Â  // ---------------------------
Â  Â  // Comments loader (safe + handles missing fields)
Â  Â  // ---------------------------
Â  Â  async function loadComments() {
Â  Â  Â  // Ensure the game doc is there first (this also prevents rules complaining)
Â  Â  Â  const gameRef = doc(db, 'games', gameId);
Â  Â  Â  try {
Â  Â  Â  Â  await ensureDoc(gameRef, { likes: 0, dislikes: 0 });
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('Could not ensure game doc before loading comments', err);
Â  Â  Â  }

Â  Â  Â  const commentsRef = collection(db, 'games', gameId, 'comments');
Â  Â  Â  let q = query(commentsRef, orderBy('timestamp', 'desc'));
Â  Â  Â  const sortValue = commentsSortEl?.value || 'newest';
Â  Â  Â  if (sortValue === 'oldest') q = query(commentsRef, orderBy('timestamp', 'asc'));

Â  Â  Â  try {
Â  Â  Â  Â  const snapshot = await getDocs(q);
Â  Â  Â  Â  commentListEl.innerHTML = '';
Â  Â  Â  Â  snapshot.forEach((docSnap) => {
Â  Â  Â  Â  Â  const data = docSnap.data();
Â  Â  Â  Â  Â  const commentId = docSnap.id;
Â  Â  Â  Â  Â  const dateText = data.timestamp ? (data.timestamp.toDate().toLocaleString()) : 'Unknown Date';
Â  Â  Â  Â  Â  const commentEl = document.createElement('div');
Â  Â  Â  Â  Â  commentEl.className = 'comment-item';
Â  Â  Â  Â  Â  commentEl.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="comment-header">
Â  Â  Â  Â  Â  Â  Â  <div class="comment-author">${(data.userName) ? escapeHtml(data.userName) : 'Anonymous'}</div>
Â  Â  Â  Â  Â  Â  Â  <div class="comment-date">${escapeHtml(dateText)}</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="comment-content">${escapeHtml(data.text || '')}</div>
Â  Â  Â  Â  Â  Â  <div class="comment-actions">
Â  Â  Â  Â  Â  Â  Â  <button class="comment-like-btn" data-comment-id="${commentId}">ğŸ‘ <span class="comment-rating-count">${data.likes || 0}</span></button>
Â  Â  Â  Â  Â  Â  Â  <button class="comment-dislike-btn" data-comment-id="${commentId}">ğŸ‘ <span class="comment-rating-count">${data.dislikes || 0}</span></button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  commentListEl.appendChild(commentEl);
Â  Â  Â  Â  });

Â  Â  Â  Â  // Add event listeners for comment voting buttons
Â  Â  Â  Â  document.querySelectorAll('.comment-like-btn, .comment-dislike-btn').forEach(btn => {
Â  Â  Â  Â  Â  btn.addEventListener('click', handleCommentInteraction);
Â  Â  Â  Â  });
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('Error loading comments:', err);
Â  Â  Â  Â  commentListEl.innerHTML = '<p>Error loading comments.</p>';
Â  Â  Â  }
Â  Â  }

Â  Â  // ---------------------------
Â  Â  // Post a new comment (creates required fields automatically)
Â  Â  // ---------------------------
Â  Â  async function handlePostComment() {
Â  Â  Â  if (!currentUser) { alert('Please log in to post a comment.'); return; }
Â  Â  Â  const text = commentInput.value.trim();
Â  Â  Â  if (!text) { alert('Please enter a comment.'); return; }

Â  Â  Â  const commentsRef = collection(db, 'games', gameId, 'comments');
Â  Â  Â  try {
Â  Â  Â  Â  // Add with serverTimestamp so rules requiring timestamp pass
Â  Â  Â  Â  await addDoc(commentsRef, {
Â  Â  Â  Â  Â  userId: currentUser.uid,
Â  Â  Â  Â  Â  userName: currentUser.displayName || currentUser.email || 'Anonymous User',
Â  Â  Â  Â  Â  text,
Â  Â  Â  Â  Â  timestamp: serverTimestamp(),
Â  Â  Â  Â  Â  likes: 0,
Â  Â  Â  Â  Â  dislikes: 0
Â  Â  Â  Â  });
Â  Â  Â  Â  commentInput.value = '';
Â  Â  Â  Â  console.log('Comment posted by', currentUser.uid);
Â  Â  Â  Â  await loadComments(); // Reload to show the new comment
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('Error posting comment:', err);
Â  Â  Â  Â  alert('An error occurred posting your comment. Please try again.');
Â  Â  Â  }
Â  Â  }

Â  Â  // ---------------------------
Â  Â  // Comment likes/dislikes (NEW)
Â  Â  // ---------------------------
Â  Â  async function handleCommentInteraction(e) {
Â  Â  Â  const btn = e.currentTarget;
Â  Â  Â  const commentId = btn.dataset.commentId;
Â  Â  Â  const voteType = btn.classList.contains('comment-like-btn') ? 'up' : 'down';

Â  Â  Â  if (!currentUser) {
Â  Â  Â  Â  alert('Please log in to vote on comments.');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  try {
Â  Â  Â  Â  // Ensure the main game and comment docs exist first
Â  Â  Â  Â  const gameRef = doc(db, 'games', gameId);
Â  Â  Â  Â  await ensureDoc(gameRef, { likes: 0, dislikes: 0 });

Â  Â  Â  Â  const commentRef = doc(db, 'games', gameId, 'comments', commentId);
Â  Â  Â  Â  // Ensure the comment doc exists (it should if it's displayed, but be safe)
Â  Â  Â  Â  await ensureDoc(commentRef, { likes: 0, dislikes: 0, userId: 'temp', userName: 'temp', text: 'temp', timestamp: serverTimestamp() });

Â  Â  Â  Â  // Reference to the user's specific vote for this comment
Â  Â  Â  Â  const userVoteRef = doc(db, 'games', gameId, 'comments', commentId, 'userVotes', currentUser.uid);

Â  Â  Â  Â  // Get current user vote state
Â  Â  Â  Â  const userVoteSnap = await getDoc(userVoteRef);
Â  Â  Â  Â  const currentVote = userVoteSnap.exists() ? userVoteSnap.data().vote : null;

Â  Â  Â  Â  // Determine the new vote
Â  Â  Â  Â  const newVote = (currentVote === voteType) ? null : voteType; // Toggle off if same button clicked again

Â  Â  Â  Â  // Calculate the change in counts
Â  Â  Â  Â  let likesChange = 0;
Â  Â  Â  Â  let dislikesChange = 0;

Â  Â  Â  Â  if (currentVote === 'up') likesChange -= 1;
Â  Â  Â  Â  if (currentVote === 'down') dislikesChange -= 1;
Â  Â  Â  Â  if (newVote === 'up') likesChange += 1;
Â  Â  Â  Â  if (newVote === 'down') dislikesChange += 1;

Â  Â  Â  Â  // Update the comment's total vote counts
Â  Â  Â  Â  const commentUpdates = {};
Â  Â  Â  Â  if (likesChange !== 0) commentUpdates.likes = increment(likesChange);
Â  Â  Â  Â  if (dislikesChange !== 0) commentUpdates.dislikes = increment(dislikesChange);
Â  Â  Â  Â  await updateDoc(commentRef, commentUpdates);

Â  Â  Â  Â  // Update or delete the user's vote record
Â  Â  Â  Â  if (newVote) {
Â  Â  Â  Â  Â  await setDoc(userVoteRef, { vote: newVote }, { merge: true });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // Remove the vote document if toggling off
Â  Â  Â  Â  Â  await deleteDoc(userVoteRef).catch(err => {
Â  Â  Â  Â  Â  Â  if (err.code !== 'not-found') throw err; // Ignore if it didn't exist
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  console.log(`User ${currentUser.uid} voted ${newVote} on comment ${commentId}. Counts updated.`);
Â  Â  Â  Â  // Reload comments to reflect the updated vote counts visually
Â  Â  Â  Â  await loadComments();

Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('Error handling comment vote:', err);
Â  Â  Â  Â  alert('An error occurred while voting on the comment. Please try again.');
Â  Â  Â  Â  // Optionally reload comments to revert optimistic UI changes if implemented
Â  Â  Â  Â  // await loadComments();
Â  Â  Â  }
Â  Â  }


Â  Â  // ---------------------------
Â  Â  // Like/Dislike for the game (robust + create missing docs & userInteraction)
Â  Â  // ---------------------------
Â  Â  async function handleLikeDislike(buttonType) {
Â  Â  Â  if (!currentUser) { alert('Please log in to like or dislike.'); return; }

Â  Â  Â  const gameRef = doc(db, 'games', gameId);
Â  Â  Â  const userInteractionRef = doc(db, 'games', gameId, 'userInteractions', currentUser.uid);

Â  Â  Â  try {
Â  Â  Â  Â  // Ensure game doc exists with likes/dislikes
Â  Â  Â  Â  await ensureDoc(gameRef, { likes: 0, dislikes: 0 });

Â  Â  Â  Â  // Ensure user interaction doc exists (may be missing)
Â  Â  Â  Â  const userSnap = await getDoc(userInteractionRef);
Â  Â  Â  Â  const currentInteraction = userSnap.exists() ? userSnap.data().action : null;
Â  Â  Â  Â  const newAction = (currentInteraction === buttonType) ? null : buttonType;

Â  Â  Â  Â  // Compute new counts based on current state
Â  Â  Â  Â  const gameSnap = await getDoc(gameRef);
Â  Â  Â  Â  const gameData = gameSnap.exists() ? gameSnap.data() : { likes: 0, dislikes: 0 };
Â  Â  Â  Â  let likes = gameData.likes || 0;
Â  Â  Â  Â  let dislikes = gameData.dislikes || 0;

Â  Â  Â  Â  if (currentInteraction === 'like') likes = Math.max(0, likes - 1);
Â  Â  Â  Â  if (currentInteraction === 'dislike') dislikes = Math.max(0, dislikes - 1);
Â  Â  Â  Â  if (newAction === 'like') likes = likes + 1;
Â  Â  Â  Â  if (newAction === 'dislike') dislikes = dislikes + 1;

Â  Â  Â  Â  // Update game doc (set new counts)
Â  Â  Â  Â  await updateDoc(gameRef, { likes, dislikes });

Â  Â  Â  Â  // Update or delete user interaction doc
Â  Â  Â  Â  if (newAction) {
Â  Â  Â  Â  Â  await setDoc(userInteractionRef, { action: newAction }, { merge: true });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // remove the document if toggling off
Â  Â  Â  Â  Â  await deleteDoc(userInteractionRef).catch(err => {
Â  Â  Â  Â  Â  Â  if (err.code !== 'not-found') throw err;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // Reflect immediately in UI
Â  Â  Â  Â  likeCountEl.textContent = likes;
Â  Â  Â  Â  dislikeCountEl.textContent = dislikes;
Â  Â  Â  Â  likeBtn.classList.toggle('active', newAction === 'like');
Â  Â  Â  Â  dislikeBtn.classList.toggle('active', newAction === 'dislike');

Â  Â  Â  Â  console.log(`User ${currentUser.uid} set action to ${newAction} for game ${gameId}`);
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('Error updating like/dislike:', err);
Â  Â  Â  Â  alert('An error occurred. Please try again.');
Â  Â  Â  Â  await loadGameRatings();
Â  Â  Â  }
Â  Â  }

Â  Â  // ---------------------------
Â  Â  // Utilities: small helpers
Â  Â  // ---------------------------
Â  Â  function escapeHtml(str) {
Â  Â  Â  if (!str) return '';
Â  Â  Â  return String(str).replace(/[&<>"'`=\/]/g, function (s) {
Â  Â  Â  Â  return ({
Â  Â  Â  Â  Â  '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;'
Â  Â  Â  Â  })[s];
Â  Â  Â  });
Â  Â  }

Â  Â  // ---------------------------
Â  Â  // Price: Simplified to display "Free"
Â  Â  // - Removed all complex currency logic, exchange rate fetching, and region detection.
Â  Â  // ---------------------------
Â  Â  async function renderLocalizedPrice() {
Â  Â  Â  // MODIFICATION: Display "Free" since BASE_USD_PRICE is 0.00
Â  Â  Â  if (BASE_USD_PRICE === 0.00) {
Â  Â  Â  Â  priceEl.textContent = `Free`;
Â  Â  Â  } else {
Â  Â  Â  Â  // Fallback to USD display for non-zero price if needed, but not using API anymore
Â  Â  Â  Â  priceEl.textContent = `USD ${BASE_USD_PRICE.toFixed(2)}`;
Â  Â  Â  }
Â  Â  Â  // Update buy button text now that price is ready
Â  Â  Â  buyBtn.innerHTML = `Buy â€” <span id="price-el" class="price">${priceEl.textContent}</span>`;
Â  Â  }

Â  Â  // ---------------------------
Â  Â  // Event listeners (attach after DOM loaded)
Â  Â  // ---------------------------
Â  Â  document.addEventListener('DOMContentLoaded', async () => {
Â  Â  Â  // Attach listeners
Â  Â  Â  postCommentBtn.addEventListener('click', handlePostComment);
Â  Â  Â  commentsSortEl.addEventListener('change', loadComments);
Â  Â  Â  likeBtn.addEventListener('click', () => handleLikeDislike('like'));
Â  Â  Â  dislikeBtn.addEventListener('click', () => handleLikeDislike('dislike'));
Â  Â  Â  wishBtn.addEventListener('click', handleWishlistToggle);
Â  Â  Â  
Â  Â  Â  // Keep the required alert for buy button
Â  Â  Â  buyBtn.addEventListener('click', () => {
Â  Â  Â  Â  if (!currentUser) {
Â  Â  Â  Â  Â  Â  alert('Please log in to purchase.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  alert('This game is not yet listed for purchase.');
Â  Â  Â  });

Â  Â  Â  // Initial loads
Â  Â  Â  await renderLocalizedPrice();
Â  Â  Â  await loadGameRatings();
Â  Â  Â  await loadComments();

Â  Â  Â  // Optional: poll or set interval to refresh ratings/comments if desired
Â  Â  });

Â  Â  // Expose some helpers to window for debugging (optional)
Â  Â  window.__photon_debug = {
Â  Â  Â  ensureDoc, loadGameRatings, loadComments, renderLocalizedPrice
Â  Â  };
</script>
</body>
</html>
