<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>STAC: Code Grey - Photon Studios</title>
  <style>
    /* (CSS kept exactly as before) */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: Arial, sans-serif;
      color: white;
      background: #1b2838;
      overflow-x: hidden;
      position: relative;
    }
    #bg-video { position: fixed; top:0; left:0; width:100vw; height:100vh; object-fit:cover; z-index:-2; }
    .dark-overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); z-index:-1; }
    .navbar { position: fixed; top:0; width:100%; display:flex; justify-content:space-between; align-items:center; padding:15px 40px; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); z-index:100; }
    .logo { font-size:1.8rem; font-weight:bold; color:#fff; }
    .nav-links { display:flex; gap:30px; }
    .nav-links a { color:#ccc; text-decoration:none; transition:0.3s; }
    .nav-links a:hover { color:#fff; }
    #login-btn { padding:8px 15px; background:rgba(255,255,255,0.12); border:1px solid white; border-radius:6px; color:white; cursor:pointer; backdrop-filter: blur(6px); font-weight:bold; }
    #login-btn:hover { background: rgba(255,255,255,0.25); }
    .container { padding: 100px 40px 40px; }
    .game-header { text-align:center; margin-bottom:30px; }
    .game-title { font-size:2.5rem; margin-bottom:10px; }
    .game-tagline { font-size:1.2rem; color:#aaa; margin-bottom:20px; }
    .game-image-main { width:100%; max-width:800px; margin:0 auto 20px; display:block; border-radius:8px; object-fit:cover; height:400px; }
    .game-meta { display:flex; justify-content:center; gap:20px; margin-bottom:20px; flex-wrap:wrap; }
    .meta-item { background: rgba(50,60,70,0.6); padding:8px 15px; border-radius:4px; }
    .game-description { max-width:800px; margin:0 auto 30px; line-height:1.6; }
    .game-actions { text-align:center; margin-bottom:30px; }
    .btn-buy, .btn-wish { padding:12px 25px; border:none; border-radius:4px; cursor:pointer; margin:0 10px; font-size:1rem; transition:0.2s; }
    .btn-buy { background:#5aa9e6; color:white; } .btn-buy:hover { background:#4a99d6; }
    .btn-wish { background: rgba(255,255,255,0.1); color:white; border:1px solid #555; } .btn-wish:hover { background: rgba(255,255,255,0.2); }
    .btn-wish.active { background:#4caf50; }
    .like-dislike-section { text-align:center; margin:20px 0 40px; }
    .like-dislike-buttons { display:inline-flex; gap:15px; align-items:center; }
    .like-btn, .dislike-btn { background:none; border:none; color:#999; cursor:pointer; font-size:1.8rem; transition:0.2s; padding:5px; }
    .like-btn:hover, .dislike-btn:hover { color:#5aa9e6; }
    .like-btn.active { color:#4caf50; } .dislike-btn.active { color:#f44336; }
    .rating-count { font-size:1rem; color:#aaa; margin:0 10px; }
    .comments-section { max-width:800px; margin:0 auto; }
    .comments-header { margin-bottom:20px; } .comments-header h2 { display:inline-block; margin-right:15px; }
    .comments-sort { display:inline-block; }
    .comment-form { margin-bottom:30px; }
    .comment-form textarea { width:100%; padding:10px; border-radius:4px; border:1px solid #555; background: rgba(30,40,50,0.8); color:white; resize:vertical; min-height:80px; margin-bottom:10px; }
    .comment-form button { padding:10px 20px; background:#5aa9e6; color:white; border:none; border-radius:4px; cursor:pointer; } .comment-form button:hover { background:#4a99d6; }
    .comment-list { } .comment-item { padding:15px; background: rgba(30,40,50,0.6); border-radius:4px; margin-bottom:15px; }
    .comment-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .comment-author { font-weight:bold; color:#5aa9e6; } .comment-date { font-size:0.8rem; color:#777; } .comment-content { line-height:1.5; } .comment-actions { margin-top:8px; }
    .comment-like-btn, .comment-dislike-btn { background:none; border:none; color:#999; cursor:pointer; font-size:0.9rem; margin-right:10px; } .comment-like-btn:hover, .comment-dislike-btn:hover { color:#5aa9e6; } .comment-like-btn.active { color:#4caf50; } .comment-dislike-btn.active { color:#f44336; } .comment-rating-count { font-size:0.8rem; color:#aaa; margin-left:5px; }
    .price { display:inline-block; margin-left:8px; font-weight:bold; color:#fff; background: rgba(0,0,0,0.3); padding:6px 10px; border-radius:6px; }
  </style>
</head>
<body>
  <video id="bg-video" autoplay muted loop>
    <source src="../videos/blackhole.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>
  <div class="dark-overlay"></div>

  <div class="navbar">
    <div class="logo">PHOTON STUDIOS</div>
    <div style="display:flex;align-items:center;gap:30px;">
      <div class="nav-links">
        <a href="../index.html">Home</a>
        <a href="../photonstore.html">Shop</a>
        <a href="../photonstudio.html">News</a>
      </div>
      <button id="login-btn">Login</button>
    </div>
  </div>

  <div class="container">
    <div class="game-header">
      <h1 class="game-title">STAC: Code Grey</h1>
      <p class="game-tagline">Deeper than dark, covert missions unfold</p>
      <img src="https://placehold.co/800x400/222222/FFFFFF?text=STAC+Code+Grey" alt="STAC: Code Grey Banner" class="game-image-main">
      <div class="game-meta">
        <div class="meta-item">Developer: Photon Studios</div>
        <div class="meta-item">Publisher: Photon Studios</div>
        <div class="meta-item">Release Date: 21st December 2025</div>
        <div class="meta-item">Genre: Action / Tactical</div>
      </div>
    </div>

    <div class="game-description">
      <p>STAC: Code Grey plunges you into the shadows of covert operations. Join the elite STAC agents as they dismantle a web of corruption and drug syndicates funded by MCA-6. Tactical combat, stealth operations, and cinematic sequences await.</p>
      <p>Features:</p>
      <ul>
        <li>Seven elite agents with unique skills</li>
        <li>Multi-mission tactical gameplay</li>
        <li>Intense cinematic cutscenes</li>
        <li>Stealth and combat mechanics</li>
        <li>Pay-As-You-Like system</li>
      </ul>
    </div>

    <div class="game-actions">
      <a href="https://gamejolt.com/games/stac-code-red/1037443" target="_blank" id="buy-btn" class="buy-btn">Download on Game Jolt</a>
      <button class="btn-wish" id="wish-btn">Add to Wishlist</button>
    </div>

    <div class="like-dislike-section">
      <h3>How do you feel about STAC: Code Grey?</h3>
      <div class="like-dislike-buttons">
        <button class="like-btn" id="like-btn">üëç</button>
        <span class="rating-count" id="like-count">0</span>
        <span> / </span>
        <span class="rating-count" id="dislike-count">0</span>
        <button class="dislike-btn" id="dislike-btn">üëé</button>
      </div>
    </div>

    <div class="comments-section">
      <div class="comments-header">
        <h2>Community Reviews</h2>
        <select class="comments-sort" id="comments-sort">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="popular">Most Popular</option>
        </select>
      </div>

      <div class="comment-form">
        <textarea id="comment-input" placeholder="Write your review or comment..."></textarea>
        <button id="post-comment-btn">Post Comment</button>
      </div>

      <div class="comment-list" id="comment-list"></div>
    </div>
  </div>

 <script type="module">
  // ---------------------------
  // Firebase imports
  // ---------------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { 
    getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import { 
    getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, getDocs, addDoc, deleteDoc, arrayUnion, arrayRemove, query, orderBy, serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // ---------------------------
  // Config
  // ---------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyCsulwdk4ryzoCwpuKji5a8b-jXeG5ews4",
    authDomain: "photon-userbase.firebaseapp.com",
    projectId: "photon-userbase",
    storageBucket: "photon-userbase.firebasestorage.app",
    messagingSenderId: "66493624110",
    appId: "1:66493624110:web:d820995afc5b2bcad354bf",
    measurementId: "G-9RJRPKKNZV"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // ---------------------------
  // Game / DOM references
  // ---------------------------
  const GAME_ID = 'new-game-id';  // Change to your new game
  const BASE_USD_PRICE = 0;       // All ratings/price start at 0

  let currentUser = null;

  const loginBtn = document.getElementById('login-btn');
  const likeBtn = document.getElementById('like-btn');
  const dislikeBtn = document.getElementById('dislike-btn');
  const likeCountEl = document.getElementById('like-count');
  const dislikeCountEl = document.getElementById('dislike-count');
  const wishBtn = document.getElementById('wish-btn');
  const priceEl = document.getElementById('price-el');
  const buyBtn = document.getElementById('buy-btn');

  const commentInput = document.getElementById('comment-input');
  const postCommentBtn = document.getElementById('post-comment-btn');
  const commentListEl = document.getElementById('comment-list');
  const commentsSortEl = document.getElementById('comments-sort');

  // ---------------------------
  // Helpers
  // ---------------------------
  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"'`=\/]/g, s =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[s]);
  }

  async function ensureDoc(docRef, defaultData = {}) {
    try {
      const snap = await getDoc(docRef);
      if (!snap.exists()) {
        await setDoc(docRef, defaultData, {merge:true});
      } else {
        const data = snap.data();
        const update = {};
        for (const k in defaultData) if (!(k in data)) update[k] = defaultData[k];
        if (Object.keys(update).length) await updateDoc(docRef, update);
      }
    } catch(err){ console.error('ensureDoc error', err); throw err; }
  }

  // ---------------------------
  // Auth
  // ---------------------------
  onAuthStateChanged(auth, async (user)=>{
    currentUser = user;
    if(user){
      loginBtn.textContent = user.displayName || user.email || 'Logged In';
      try{
        const userRef = doc(db,'users',user.uid);
        await ensureDoc(userRef,{wishlist:[]});
        checkWishlist();
      } catch(err){console.error(err);}
    } else {
      loginBtn.textContent = 'Login';
      wishBtn.textContent = 'Add to Wishlist';
      wishBtn.classList.remove('active');
      wishBtn.disabled = false;
    }
  });

  loginBtn.addEventListener('click', ()=>{
    if(currentUser){
      signOut(auth).catch(err=>console.error(err));
    } else {
      signInWithPopup(auth,provider)
        .then(result=>{ currentUser=result.user; })
        .catch(err=>{ console.error(err); alert('Login failed'); });
    }
  });

  // ---------------------------
  // Wishlist
  // ---------------------------
  async function checkWishlist(){
    if(!currentUser) return;
    const userRef = doc(db,'users',currentUser.uid);
    try{
      const snap = await getDoc(userRef);
      const wishlist = snap.exists() ? snap.data().wishlist||[] : [];
      if(wishlist.includes(GAME_ID)){
        wishBtn.textContent='Remove from Wishlist';
        wishBtn.classList.add('active');
      } else {
        wishBtn.textContent='Add to Wishlist';
        wishBtn.classList.remove('active');
      }
    } catch(err){ console.error(err); }
  }

  async function toggleWishlist(){
    if(!currentUser){ alert('Login first'); return; }
    const userRef = doc(db,'users',currentUser.uid);
    await ensureDoc(userRef,{wishlist:[]});
    const snap = await getDoc(userRef);
    const wishlist = snap.data().wishlist||[];
    if(wishlist.includes(GAME_ID)){
      await updateDoc(userRef,{wishlist:arrayRemove(GAME_ID)});
    } else {
      await updateDoc(userRef,{wishlist:arrayUnion(GAME_ID)});
    }
    checkWishlist();
  }

  wishBtn.addEventListener('click', toggleWishlist);

  // ---------------------------
  // Game Ratings
  // ---------------------------
  async function loadGameRatings(){
    const gameRef = doc(db,'games',GAME_ID);
    await ensureDoc(gameRef,{likes:0,dislikes:0});
    const snap = await getDoc(gameRef);
    const data = snap.data();
    likeCountEl.textContent = data.likes||0;
    dislikeCountEl.textContent = data.dislikes||0;
    likeBtn.classList.toggle('active', false);
    dislikeBtn.classList.toggle('active', false);
  }

  async function handleLikeDislike(type){
    if(!currentUser){ alert('Login first'); return; }
    const gameRef = doc(db,'games',GAME_ID);
    const userRef = doc(db,'games',GAME_ID,'userInteractions',currentUser.uid);
    await ensureDoc(gameRef,{likes:0,dislikes:0});
    const userSnap = await getDoc(userRef);
    const currentAction = userSnap.exists()? userSnap.data().action : null;
    const newAction = (currentAction===type)?null:type;

    const gameSnap = await getDoc(gameRef);
    let {likes=0, dislikes=0} = gameSnap.data();
    if(currentAction==='like') likes=Math.max(0,likes-1);
    if(currentAction==='dislike') dislikes=Math.max(0,dislikes-1);
    if(newAction==='like') likes++;
    if(newAction==='dislike') dislikes++;

    await updateDoc(gameRef,{likes,dislikes});
    if(newAction) await setDoc(userRef,{action:newAction},{merge:true});
    else await deleteDoc(userRef).catch(()=>{});
    likeCountEl.textContent=likes;
    dislikeCountEl.textContent=dislikes;
    likeBtn.classList.toggle('active', newAction==='like');
    dislikeBtn.classList.toggle('active', newAction==='dislike');
  }

  likeBtn.addEventListener('click', ()=>handleLikeDislike('like'));
  dislikeBtn.addEventListener('click', ()=>handleLikeDislike('dislike'));

  // ---------------------------
  // Comments
  // ---------------------------
  async function loadComments(){
    const commentsRef = collection(db,'games',GAME_ID,'comments');
    let q = query(commentsRef, orderBy(commentsSortEl?.value==='oldest'?'timestamp':'timestamp','desc'));
    try{
      const snapshot = await getDocs(q);
      commentListEl.innerHTML='';
      snapshot.forEach(docSnap=>{
        const data = docSnap.data();
        const commentId = docSnap.id;
        const commentEl = document.createElement('div');
        commentEl.className='comment-item';
        commentEl.innerHTML=`
          <div class="comment-header">
            <span class="comment-author">${escapeHtml(data.userName||'Anonymous')}</span>
            <span class="comment-date">${data.timestamp ? data.timestamp.toDate().toLocaleString() : ''}</span>
          </div>
          <div class="comment-content">${escapeHtml(data.text||'')}</div>
          <div class="comment-actions">
            <button class="comment-like-btn" data-id="${commentId}">üëç ${data.likes||0}</button>
            <button class="comment-dislike-btn" data-id="${commentId}">üëé ${data.dislikes||0}</button>
          </div>
        `;
        commentListEl.appendChild(commentEl);
      });

      document.querySelectorAll('.comment-like-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>voteComment(btn,'like'));
      });
      document.querySelectorAll('.comment-dislike-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>voteComment(btn,'dislike'));
      });

    } catch(err){ console.error(err); }
  }

  async function postComment(){
    if(!currentUser){ alert('Login first'); return; }
    const text = commentInput.value.trim();
    if(!text){ alert('Type something'); return; }
    const commentsRef = collection(db,'games',GAME_ID,'comments');
    await addDoc(commentsRef,{
      userId: currentUser.uid,
      userName: currentUser.displayName || currentUser.email || 'Anonymous',
      text,
      likes:0,
      dislikes:0,
      timestamp: serverTimestamp()
    });
    commentInput.value='';
    loadComments();
  }

  postCommentBtn.addEventListener('click', postComment);

  async function voteComment(btn,type){
    if(!currentUser){ alert('Login first'); return; }
    const commentId = btn.dataset.id;
    const commentRef = doc(db,'games',GAME_ID,'comments',commentId);
    const userVoteRef = doc(db,'games',GAME_ID,'comments',commentId,'votes',currentUser.uid);
    await ensureDoc(commentRef,{likes:0,dislikes:0,text:'',userName:'Anonymous',timestamp:serverTimestamp()});

    const voteSnap = await getDoc(userVoteRef);
    const currentVote = voteSnap.exists()? voteSnap.data().vote:null;
    const newVote = currentVote===type ? null:type;

    let likesChange=0, dislikesChange=0;
    if(currentVote==='like') likesChange--;
    if(currentVote==='dislike') dislikesChange--;
    if(newVote==='like') likesChange++;
    if(newVote==='dislike') dislikesChange++;

    const updates={};
    if(likesChange!==0) updates.likes=increment(likesChange);
    if(dislikesChange!==0) updates.dislikes=increment(dislikesChange);
    await updateDoc(commentRef,updates);

    if(newVote) await setDoc(userVoteRef,{vote:newVote},{merge:true});
    else await deleteDoc(userVoteRef).catch(()=>{});

    loadComments();
  }

  // ---------------------------
  // Price
  // ---------------------------
  function renderPrice(){
    priceEl.textContent = BASE_USD_PRICE===0 ? 'Free' : `USD ${BASE_USD_PRICE.toFixed(2)}`;
    buyBtn.innerHTML=`Buy ‚Äî <span id="price-el">${priceEl.textContent}</span>`;
  }

 

  // ---------------------------
  // Init on DOM ready
  // ---------------------------
  document.addEventListener('DOMContentLoaded', async ()=>{
    renderPrice();
    await loadGameRatings();
    await loadComments();
  });

</script>

</body>
</html>
